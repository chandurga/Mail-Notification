name: Reusable Workflow to Run Tests

on:
  workflow_call:
    inputs:
      tags-of-tests-to-include:
        required: true
        type: string
      tags-of-tests-to-exclude:
        required: false
        type: string
        default: "flaky, failing"
      test-environment:
        required: false
        type: string
        default: "MAIL_NOTIFICATION"
      run-name:
        required: false
        type: string
        default: "CI"

jobs:
  run-tests:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
      - name: Start Selenoid server
        uses: n-ton4/selenoid-github-action@master
        id: start-selenoid
        continue-on-error: false
        with:
          version: 1.10.1
          args: -limit 5
          browsers: chrome
          last-versions: 1

      - name: Check Selenoid has been started
        run: curl http://localhost:4444/status

      - uses: actions/checkout@v3

      - name: Set up JDK 11
        uses: actions/setup-java@v3
        with:
          java-version: '11'
          distribution: 'temurin'
          cache: maven

      - name: Unlock secrets
        uses: sliteteam/github-action-git-crypt-unlock@1.2.0
        env:
          GIT_CRYPT_KEY: ${{ secrets.GIT_CRYPT_KEY }}

      - name: Test with Maven
        id: run-tests
        run: |
          mvn clean -B package --file pom.xml \
            -DexcludedGroups="${{ inputs.tags-of-tests-to-exclude }}" \
            -Dgroups="${{ inputs.tags-of-tests-to-include }}" \
            -DTEST_ENV="${{ inputs.test-environment }}" \
            -DRUN_NAME="${{ inputs.run-name }}" \
            -Dselenide.remote=http://localhost:4444/wd/hub \
            -DTRIGGERED_BY=${{ github.event_name }} \
            | tee maven-output.log

      - name: Parse test results
        id: parse-results
        run: |
          test_results=$(cat maven-output.log)
          total_tests=$(echo "$test_results" | grep -oP 'Tests run: \d+' | awk '{print $3}')
          total_failures=$(echo "$test_results" | grep -oP 'Failures: \d+' | awk '{print $2}')
          total_errors=$(echo "$test_results" | grep -oP 'Errors: \d+' | awk '{print $2}')
          total_skipped=$(echo "$test_results" | grep -oP 'Skipped: \d+' | awk '{print $2}')
          test_cases=$(grep -oP '(?<=\[INFO\] Results - ).*(?= \[INFO\])' maven-output.log)
          
          echo "TOTAL_TESTS=$total_tests" >> $GITHUB_ENV
          echo "TOTAL_FAILURES=$total_failures" >> $GITHUB_ENV
          echo "TOTAL_ERRORS=$total_errors" >> $GITHUB_ENV
          echo "TOTAL_SKIPPED=$total_skipped" >> $GITHUB_ENV
          echo "TEST_CASES=$test_cases" >> $GITHUB_ENV

      - name: Update dependency graph
        if: always()
        uses: advanced-security/maven-dependency-submission-action@571e99aab1055c2e71a1e2309b9691de18d6b7d6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}  # Ensure correct permissions
